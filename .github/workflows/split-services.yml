name: Split Services to Branches

on:
  push:
    branches:
      - main

jobs:
  sync-backend:
    name: Sync Backend to backend branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to backend branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if backend branch exists, create if not
          if git ls-remote --heads origin backend | grep -q backend; then
            git checkout backend
            git pull origin backend
          else
            git checkout --orphan backend
            git rm -rf . || true
            git commit --allow-empty -m "Initialize backend branch"
            git push origin backend
            git checkout backend
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout backend files from main
          git checkout main -- backend/
          git checkout main -- services/
          git checkout main -- .gitignore || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for backend branch"
          else
            git commit -m "Sync backend and services from main"
            git push origin backend
          fi

  sync-frontend:
    name: Sync Frontend to frontend branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to frontend branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if frontend branch exists, create if not
          if git ls-remote --heads origin frontend | grep -q frontend; then
            git checkout frontend
            git pull origin frontend
          else
            git checkout --orphan frontend
            git rm -rf . || true
            git commit --allow-empty -m "Initialize frontend branch"
            git push origin frontend
            git checkout frontend
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout only frontend from main
          git checkout main -- frontend/
          git checkout main -- .gitignore || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for frontend branch"
          else
            git commit -m "Sync frontend from main"
            git push origin frontend
          fi

  sync-ai:
    name: Sync AI to ai branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to ai branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if ai branch exists, create if not
          if git ls-remote --heads origin ai | grep -q ai; then
            git checkout ai
            git pull origin ai
          else
            git checkout --orphan ai
            git rm -rf . || true
            git commit --allow-empty -m "Initialize ai branch"
            git push origin ai
            git checkout ai
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout only AI from main
          git checkout main -- AI/
          git checkout main -- .gitignore || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for ai branch"
          else
            git commit -m "Sync AI service from main"
            git push origin ai
          fi

  sync-new-flow:
    name: Sync New Flow to new-flow branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to new-flow branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if new-flow branch exists, create if not
          if git ls-remote --heads origin new-flow | grep -q new-flow; then
            git checkout new-flow
            git pull origin new-flow
          else
            git checkout --orphan new-flow
            git rm -rf . || true
            git commit --allow-empty -m "Initialize new-flow branch"
            git push origin new-flow
            git checkout new-flow
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout only new-flow-repo from main
          git checkout main -- new-flow-repo/
          git checkout main -- .gitignore || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for new-flow branch"
          else
            git commit -m "Sync new-flow-repo from main"
            git push origin new-flow
          fi

  sync-infra:
    name: Sync Infrastructure to infra branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to infra branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if infra branch exists, create if not
          if git ls-remote --heads origin infra | grep -q infra; then
            git checkout infra
            git pull origin infra
          else
            git checkout --orphan infra
            git rm -rf . || true
            git commit --allow-empty -m "Initialize infra branch"
            git push origin infra
            git checkout infra
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout infrastructure files from main
          git checkout main -- docker-compose.yml || true
          git checkout main -- docker-compose.prod.yml || true
          git checkout main -- Dockerfile.backend || true
          git checkout main -- Dockerfile.celery || true
          git checkout main -- Dockerfile.ai-service || true
          git checkout main -- Dockerfile.frontend || true
          git checkout main -- railway.json || true
          git checkout main -- railway.celery.json || true
          git checkout main -- railway.ai-service.json || true
          git checkout main -- railway.frontend.json || true
          git checkout main -- railway.ws-proxy.json || true
          git checkout main -- render.yaml || true
          git checkout main -- integration_test.sh || true
          git checkout main -- .env.production.template || true
          git checkout main -- .gitignore || true
          git checkout main -- .github/ || true
          git checkout main -- README.md || true
          git checkout main -- PRD.md || true
          git checkout main -- TRD.md || true
          git checkout main -- BRANCHING_STRATEGY.md || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for infra branch"
          else
            git commit -m "Sync infrastructure files from main"
            git push origin infra
          fi
