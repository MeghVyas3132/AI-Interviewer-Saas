name: Split Services to Branches

on:
  push:
    branches:
      - monolith

jobs:
  sync-main:
    name: Sync Backend to main
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync to main branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if main branch exists, create if not
          if git ls-remote --heads origin main | grep -q main; then
            git checkout main
            git pull origin main
          else
            git checkout --orphan main
            git rm -rf . || true
            git commit --allow-empty -m "Initialize main branch"
            git push origin main
            git checkout main
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout backend and shared files from monolith
          git checkout monolith -- backend/
          git checkout monolith -- README.md || true
          git checkout monolith -- PRD.md || true
          git checkout monolith -- TRD.md || true
          git checkout monolith -- docker-compose.yml || true
          git checkout monolith -- docker-compose.prod.yml || true
          git checkout monolith -- Dockerfile.backend || true
          git checkout monolith -- Dockerfile.celery || true
          git checkout monolith -- Dockerfile.ai-service || true
          git checkout monolith -- Dockerfile.frontend || true
          git checkout monolith -- .gitignore || true
          git checkout monolith -- .env.production.template || true
          git checkout monolith -- integration_test.sh || true
          git checkout monolith -- railway.json || true
          git checkout monolith -- railway.celery.json || true
          git checkout monolith -- railway.ai-service.json || true
          git checkout monolith -- railway.frontend.json || true
          git checkout monolith -- railway.ws-proxy.json || true
          git checkout monolith -- render.yaml || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for main branch"
          else
            git commit -m "Sync backend and shared files from monolith"
            git push origin main
          fi

  sync-frontend:
    name: Sync Frontend to frontend branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync to frontend branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if frontend branch exists, create if not
          if git ls-remote --heads origin frontend | grep -q frontend; then
            git checkout frontend
            git pull origin frontend
          else
            git checkout --orphan frontend
            git rm -rf . || true
            git commit --allow-empty -m "Initialize frontend branch"
            git push origin frontend
            git checkout frontend
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout only frontend from monolith
          git checkout monolith -- frontend/
          git checkout monolith -- .gitignore || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for frontend branch"
          else
            git commit -m "Sync frontend from monolith"
            git push origin frontend
          fi

  sync-ai:
    name: Sync AI to ai branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync to ai branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if ai branch exists, create if not
          if git ls-remote --heads origin ai | grep -q ai; then
            git checkout ai
            git pull origin ai
          else
            git checkout --orphan ai
            git rm -rf . || true
            git commit --allow-empty -m "Initialize ai branch"
            git push origin ai
            git checkout ai
          fi

          # Remove all current files (this handles deletions)
          git rm -rf . || true

          # Checkout only AI from monolith
          git checkout monolith -- AI/
          git checkout monolith -- .gitignore || true

          # Stage all changes
          git add -A

          # Commit and push if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit for ai branch"
          else
            git commit -m "Sync AI service from monolith"
            git push origin ai
          fi
