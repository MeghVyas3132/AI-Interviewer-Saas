name: Split Services to Branches

on:
  push:
    branches:
      - monolith

jobs:
  sync-main:
    name: Sync Backend to main branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to main branch
        run: |
          git fetch origin

          if git ls-remote --heads origin main | grep -q main; then
            git checkout main
            git pull origin main
          else
            git checkout --orphan main
            git rm -rf . || true
            git commit --allow-empty -m "Initialize main branch"
            git push origin main
            git checkout main
          fi

          git rm -rf . || true

          git checkout monolith -- backend/
          git checkout monolith -- services/
          git checkout monolith -- Dockerfile.backend || true
          git checkout monolith -- Dockerfile.celery || true
          git checkout monolith -- railway.json || true
          git checkout monolith -- railway.celery.json || true
          git checkout monolith -- .gitignore || true

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit for main branch"
          else
            git commit -m "Sync backend and services from monolith"
            git push origin main
          fi

  sync-frontend:
    name: Sync Frontend to frontend branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to frontend branch
        run: |
          git fetch origin

          if git ls-remote --heads origin frontend | grep -q frontend; then
            git checkout frontend
            git pull origin frontend
          else
            git checkout --orphan frontend
            git rm -rf . || true
            git commit --allow-empty -m "Initialize frontend branch"
            git push origin frontend
            git checkout frontend
          fi

          git rm -rf . || true

          git checkout monolith -- frontend/
          git checkout monolith -- Dockerfile.frontend || true
          git checkout monolith -- railway.frontend.json || true
          git checkout monolith -- .gitignore || true

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit for frontend branch"
          else
            git commit -m "Sync frontend from monolith"
            git push origin frontend
          fi

  sync-ai:
    name: Sync AI to ai branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to ai branch
        run: |
          git fetch origin

          if git ls-remote --heads origin ai | grep -q ai; then
            git checkout ai
            git pull origin ai
          else
            git checkout --orphan ai
            git rm -rf . || true
            git commit --allow-empty -m "Initialize ai branch"
            git push origin ai
            git checkout ai
          fi

          git rm -rf . || true

          git checkout monolith -- AI/
          git checkout monolith -- Dockerfile.ai-service || true
          git checkout monolith -- railway.ai-service.json || true
          git checkout monolith -- railway.ws-proxy.json || true
          git checkout monolith -- .gitignore || true

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit for ai branch"
          else
            git commit -m "Sync AI service from monolith"
            git push origin ai
          fi

  sync-new-flow:
    name: Sync New Flow to new-flow branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to new-flow branch
        run: |
          git fetch origin

          if git ls-remote --heads origin new-flow | grep -q new-flow; then
            git checkout new-flow
            git pull origin new-flow
          else
            git checkout --orphan new-flow
            git rm -rf . || true
            git commit --allow-empty -m "Initialize new-flow branch"
            git push origin new-flow
            git checkout new-flow
          fi

          git rm -rf . || true

          git checkout monolith -- new-flow-repo/
          git checkout monolith -- .gitignore || true

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit for new-flow branch"
          else
            git commit -m "Sync new-flow-repo from monolith"
            git push origin new-flow
          fi

  sync-infra:
    name: Sync Infrastructure to infra branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout monolith branch
        uses: actions/checkout@v4
        with:
          ref: monolith
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "MeghVyas3132"
          git config user.email "megh.vyas@yahoo.com"

      - name: Sync to infra branch
        run: |
          git fetch origin

          if git ls-remote --heads origin infra | grep -q infra; then
            git checkout infra
            git pull origin infra
          else
            git checkout --orphan infra
            git rm -rf . || true
            git commit --allow-empty -m "Initialize infra branch"
            git push origin infra
            git checkout infra
          fi

          git rm -rf . || true

          git checkout monolith -- docker-compose.yml || true
          git checkout monolith -- docker-compose.prod.yml || true
          git checkout monolith -- Dockerfile.backend || true
          git checkout monolith -- Dockerfile.celery || true
          git checkout monolith -- Dockerfile.ai-service || true
          git checkout monolith -- Dockerfile.frontend || true
          git checkout monolith -- railway.json || true
          git checkout monolith -- railway.celery.json || true
          git checkout monolith -- railway.ai-service.json || true
          git checkout monolith -- railway.frontend.json || true
          git checkout monolith -- railway.ws-proxy.json || true
          git checkout monolith -- render.yaml || true
          git checkout monolith -- integration_test.sh || true
          git checkout monolith -- .env.production.template || true
          git checkout monolith -- .gitignore || true
          git checkout monolith -- .github/ || true
          git checkout monolith -- README.md || true
          git checkout monolith -- PRD.md || true
          git checkout monolith -- TRD.md || true
          git checkout monolith -- BRANCHING_STRATEGY.md || true

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit for infra branch"
          else
            git commit -m "Sync infrastructure files from monolith"
            git push origin infra
          fi
